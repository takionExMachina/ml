import pefile
import os

def PE_extract(file):
    PEfile = pefile.PE(file, fast_load=True)
    DebugSize = PEfile.OPTIONAL_HEADER.DATA_DIRECTORY[6].Size
    DebugRVA = PEfile.OPTIONAL_HEADER.DATA_DIRECTORY[6].VirtualAddress
    ImageVersion = PEfile.OPTIONAL_HEADER.MajorImageVersion
    OSVersion = PEfile.OPTIONAL_HEADER.MajorOperatingSystemVersion
    ExportRVA = PEfile.OPTIONAL_HEADER.DATA_DIRECTORY[0].VirtualAddress
    ExportSize = PEfile.OPTIONAL_HEADER.DATA_DIRECTORY[0].Size
    IATRVA = PEfile.OPTIONAL_HEADER.DATA_DIRECTORY[12].VirtualAddress
    ResSize = PEfile.OPTIONAL_HEADER.DATA_DIRECTORY[2].Size
    LinkerVersion = PEfile.OPTIONAL_HEADER.MajorLinkerVersion
    NumberOfSections = PEfile.FILE_HEADER.NumberOfSections
    StackReserveSize = PEfile.OPTIONAL_HEADER.SizeOfStackReserve
    Dll = PEfile.OPTIONAL_HEADER.DllCharacteristics
    data = [DebugSize, DebugRVA, ImageVersion, OSVersion, ExportRVA,
            ExportSize, IATRVA, ResSize, LinkerVersion, NumberOfSections,
            StackReserveSize, Dll]
    return data

def dir_walk(dirname):
    for f in os.listdir(dirname):
        csv_add_row(PE_extract(dirname + '/' + f))

def csv_add_row(data):
    with open('sample_features.csv', 'a+') as csv_file:
    csv_writer = csv.writer(csv_file, delimiter=',')
    if csv_file.readlines() == '':
        csv_writer.writerow(['DebugSize', 'DebugRVA', 'ImageVersion',
        'OSVersion', 'ExportRVA', 'ExportSize', 'IATRVA', 'ResSize',
        'LinkerVersion', 'NumberOfSections', 'StackReserveSize', 'Dll'])
    csv_writer.writerow(data)
    csv_file.close()

def main():
    dir_walk('malware_dataset/malware_samples')

main()

